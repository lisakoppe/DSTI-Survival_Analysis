---
title: Integrated evaluation of clinical, pathological and radiological prognostic factors in squamous cell carcinoma of the lung
author: Lisa KOPPE, Khwansiri NINPAN, Princy PAPPACHAN
date: 4/23/2020
---

Import the necessary packages:

```{r}
library(tidyverse)
library(survival)
library(ggplot2)
```

Load the lung cancer dataset:

```{r}
raw_data <- read.csv("lungcancer.csv", header=TRUE, sep=";", 
                     col_types=cols(Index='',
                                    Sex='',
                                    Age='',
                                    Location='',
                                    Obst_pn_or_plugging='',
                                    CT_value_Mean='',
                                    CT_value_Std_Dev='',
                                    CT_value_P_major='',
                                    CT_V_ratio='',
                                    CT_Kernel='',
                                    Necrosis='',
                                    Underlying_lung='',
                                    Multiplicity='',
                                    Effusion='',
                                    Bronchoscopy='',
                                    Differentiation='',
                                    pos_LN='',
                                    total_LN='',
                                    LN_ratio='',
                                    cT='',
                                    cN='',
                                    cM='',
                                    pT='',
                                    pN='',
                                    pM='',
                                    Smoking_state='',
                                    PY='',
                                    Cessation_time='',
                                    FVCpercentPRED='',
                                    FEV1percentPRED='',
                                    FEV1_FVC='',
                                    CEA='',
                                    post_opCTx='',
                                    post_op_RTx='',
                                    op_type='',
                                    death='',
                                    recur_or_meta='',
                                    OP_site_recur='',
                                    meta='',
                                    meta_site='',
                                    OS='',
                                    DFS=''))
```

```{r}
data <- as_tibble(raw_data)
summary(data)
names(data)
str(data)
dim(data)
head(data)
```

```{r}

```

# Univariate analysis

Global columns:
- Location: peripheral vs. central (cat)
- death: die vs. survive (bin)
- OS: overall survival: interval between the date of diagnosis and date of death (by any cause)(cont)

-----

Binary vs Binary: Fisher Test
Binary vs Continuous: Logistic Regression

## Univariate analysis - Lisa:

Clinicopathologic (part2):
- FEV1_FVC: pulmonary function test: forced expiratory volume in a second / forced vital capacity (cont)
- CEA: serum carcinoembryonic antigen (tumor marker) (cont)
- LN_ratio: lymph node ratio: number of nodes with positive tumor cells divided by the number of all resected nodes (cont)
- meta: metastasis observed (bin)
- pT: peripheral / size of original tumor (cont)
- pN: peripheral / nearby lymph nodes involved (cont)
- pM: peripheral / distant metastasis (spread of cancer from one part of the body to another) (cont)

### Binary outcome:


```{r}

```


### Relationship between Radiologic Features and Death
Radiologic Features:
1. Location 
   = Tumor location 
   (Class: 0 = Invisible, 1 = Central SCC, 2 = Peripheral SCC)
2. Obst_pn_or_plugging
   = Present of obstructive pneumonitis/ atelectais
   (Logical: 0 = Absent, 1 = Present)
3. Necrosis
   (Class: 0 = Nothing, 1 = Necrosis, 2 = Cavitization)
4. Underlying_lung
   = Underlying lung disease
   (Class: 0 = No Remarkable, 1 = Emphysema, 2 = Interstitial lung abnormality)
5. Effusion
   (Logical: 0 = Absent, 1 = Present)
6.  Death 
    (Logical: Not Death = 0, Death = 1)
7.  OS(M)


```{r}
library(tidyverse)
```

*Data Preparation*

# Dat Preparation: Check data type

```{r}
lungSCC_raw<- read_csv("LungCancer.csv",
                     col_types = cols(Location="d", Obst_pn_or_plugging = "d", Necrosis = "d", Underlying_lung = "d", Effusion = "d", death = "d", OS = "d", .default = "c"))

```

# Data Preparation: Check null value and data classification 
Use table for classification and Logical column to see how they distribute
Count null value in decimal column (OS)

```{r}
table(lungSCC_raw$Location, useNA = "always")
table(lungSCC_raw$Obst_pn_or_plugging, useNA = "always")
table(lungSCC_raw$Necrosis, useNA = "always")
table(lungSCC_raw$Underlying_lung, useNA = "always")
table(lungSCC_raw$Effusion, useNA = "always")
table(lungSCC_raw$death, useNA = "always")
sum(is.na(lungSCC_raw$death))
```

# Data Preparation: Define the meaning of each label to make it easier for interpretation

```{r}
lungSCC <- mutate(data_raw, 
               
               Location = ifelse(Location == 0, "Invisible",
                          ifelse(Location == 1, "Central", "Peripheral")),
               
               Necrosis = ifelse(Necrosis == 0, "NoRemark",
                          ifelse(Necrosis == 1, "Necrosis", "Cavitization")),
               
               Underlying_lung = ifelse(Underlying_lung == 0, "NoRemark",
                                 ifelse(Underlying_lung == 1, "Emphysema", "ILA")))
```


*Part 1: Test relationship between radiologic features and death (Not consider survival duration)*

Methods used:
1. Fisher's exact test (Determine the relationship between two categorical variables)
2. Logistic regression (Determine the relationship between categorical continuous variables)


# Fisher's exact test
Determine the relationship between two categorical variables

Hypotheses:
H0: There is no relationship between the two categorical variables
H1 : The variables are dependent. Knowing the value of one variable helps to predict the value of the other variable 

Odds ratio:
Odds for death in patient with specific condition
divided by odds for death in patient without specific condition
If those 2 sets of patient have equal odds (odds ratio = 1), that specific condition are independent to death status


Here we want to define
1. Diffence in risk of death in patient with and without obstructive pneumonitis/ atelectais
2. Diffence in risk of death in patient with and without lung effusion


Diffence in risk of death in patient with and without obstructive pneumonitis/ atelectais 
```{r}
with(lungSCC, fisher.test(table(death, Obst_pn_or_plugging)))
```
Interpretation:
p-value is higher than the significance level of 5%, therefore; we cannot reject null hypothesis which means data not sufficinet to prove that obstructive pneumonitis/ atelectais effect the death. 

Odds ratio suggests that patients with obstructive pneumonitis/ atelectais have approximately 17% lower risk of death than that of patient without obstructive pneumonitis/ atelectais
See that 95% confidence interval ranges from 0.55, where patients with pneumonitis/atelectais have 5% lower risk of death than patients without this condition, to 1.25 which means they have 25% higher risk of death than another group of patient.
(Correlate with publication, this feature is suprisingly improve the survival time)



Diffence in risk of death in patient with and without lung effusion
```{r}
with(lungSCC, fisher.test(table(death, Effusion)))
```
Interpretation:
No relationship between death and lung effusion (p-value = 1)
Patients with lung effusion have 5% higher risk of death than patients without lung effusion




# Logistic regression

1. Diffence in risk of death based on cancer location
2. Diffence in risk of death based on cell necrosis
3. Diffence in risk of death based on underlying lung disease



1. Diffence in risk of death based on cancer location

```{r}

fit <- glm(death ~ Location, family = "binomial", data = lungSCC)
summary(fit)

```
Interpretation:
1. No significant relationship between location of lung cancer and the prediction of death status.
2. The negative value of estimate coefficient of LocationInvisible indicates that odds of invisible lung cancer is lower than odds of central lung cancer. 
To see the odds ratio between these 2 condition, we have to exponent this coefficients (see belows).
3. Odds of peripheral lung cancer is higher than that of central lung cancer


```{r}
exp(-0.3203)
exp(0.2749)
```
Interpretation:
Risk of death of patients who have invisible lung cancer is around 30% lower than patients with central lung cancer, while risk of death of peripheral lung cancer patients is around 30% higher than that of central lung cancer patients.




2. Diffence in risk of death based on cell necrosis
```{r}

fit <- glm(death ~ Necrosis, family = "binomial", data = lungSCC)
summary(fit)

```
Interpretation:
1. No cell necrosis observation shows significantly negative effect in the prediction of death in lung cancer patients with p-value 0.0238 (i.e No necrosis reduces risk of death).
2. Odds of cell necrosis and invisible cell necrosis are lower than that of cavitization in lung

```{r}
exp(-0.7482)
exp(-0.9840)
```
Interpretation:
Risk of death of lung cancer patients who have necrosis and invisible cell necrosis are around 53% and  63% lower than patients with cavitization.


3. Diffence in risk of death based on underlying lung disease

```{r}

fit <- glm(death ~ Underlying_lung, family = "binomial", data = lungSCC)
summary(fit)

```
Interpretation:
1. Interstitial lung abnormalities (ILA) shows significantly positive relationship with the risk of death with p-value 0.006.
2. Odd of ILA is higher than that of emphysema while odd of negative underlying lung disease is lower than odd of patients with emphysema. 


```{r}
exp(1.81475)
exp(-0.45911)
```
Interpretation:
Risk of death of lung cancer patients with ILA is 6 times higher than patient with emphysema while risk of death of no underlying lung disease patients is 40% lower than patients with emphysema.


