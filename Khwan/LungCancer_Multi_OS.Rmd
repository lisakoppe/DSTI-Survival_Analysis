---
title: "LungCancer_Multivar"
author: "Khwansiri NINPAN"
date: "27/04/2020"
output: word_document
---

*Multivaraites Cox Regression*

1. Backward regression to choose the best multivariate model based on AIC
2. Create one more candidate model which is the nested model from the best AIC selection >> Compare both model with concordance score and LRT

```{r}
library(survival)
library(tidyverse)
library(survminer)
library(asaur)

```

```{r}
lungSCC_raw <- read_csv("LungCancer.csv",
                         col_types=cols(Sex='c',
                                       Age='c',
                                       Location='d',
                                       Obst_pn_or_plugging='d',
                                       Necrosis='d',
                                       Underlying_lung='d',
                                       Effusion='d',
                                       LN_ratio='d',
                                       cT='c',
                                       cN='c',
                                       cM='c',
                                       pT='c',
                                       pN='c',
                                       pM='c',
                                       Smoking_state='c',  
                                       FEV1_FVC='d',
                                       CEA='d',
                                       op_type='c',
                                       death='d',
                                       OP_site_recur='l',
                                       meta='l',
                                       OS = "d",
                                       .default = 'c'))


lungSCC <- mutate(lungSCC_raw,
                  Location=ifelse(Location==0, "Peripheral","Central"),
                  
                  Necrosis=ifelse(Necrosis==0, "NoRemark",
                                  ifelse(Necrosis==1, "Necrosis", "Cavitization")),
                  
                  Underlying_lung=ifelse(Underlying_lung==0, "NoRemark",
                                         ifelse(Underlying_lung==1, "Emphysema", "ILA")),
                  
                  Sex=factor(Sex, levels=c("F", "M")),
                  
                  AG=ifelse((Age<60), "LT60", "OV60"),
          
                  AG=factor(AG),
                
                  OP=factor(op_type, labels=c("lobectomy", "pneumonectomy", "segmentectomy", "LN biopsy", "No OP")),
                                                  
                  Smoking_state=factor(Smoking_state, labels=c("unknown", "current-smoker", "ex- smoker", "non- smoker")),
                  
                  cT=factor(cT, levels=c("1", "2", "3", "4"), labels=c("cT1", "cT2", "cT3", "cT4")),
                  
                  cN=factor(cN, levels=c("1", "2", "3", "4"), labels=c("cN0", "cN1", "cN2", "cN3")),
                  
                  cM=factor(cM, levels=c("1", "3"), labels=c("cM0", "cM1b")),
                  
                  pT=factor(pT, levels=c("1", "2", "3", "4"), labels=c("pT1", "pT2", "pT3", "pT4")),
                  
                  pN=factor(pN, levels=c("1", "2", "3", "4"), labels=c("pN0", "pN1", "pN2", "pN3")),
                  
                  pM=factor(pM, levels=c("1", "3"), labels=c("pM0", "pM1b")))


```


Start with the full model with all variables
```{r}

lungSCC_fullmodel <- coxph(Surv(OS, death) ~ Location + Obst_pn_or_plugging + Necrosis + Underlying_lung + Effusion + Sex + AG + LN_ratio + cT+ cN + cM + pT+ pN+ pM + Smoking_state + FEV1_FVC + CEA + meta , data = lungSCC)

```


Automatic model selection based on AIC
``` {r}
lungSCC_multiCox <- step(lungSCC_fullmodel)
```
Interpretation:
After backward selection, we found that the best model to predict survival time composes of 11 variables with the converted AIC 1827.39 from the original AIC  
1846.56 

Note that this backward selection migh not convert to global optimum
```{r}
summary(lungSCC_multiCox)
```
Interpretation:
1. The prediction concordance score of our multivariate model is 0.732

2. Features that lead to a statistical significant higher risk (Shorter survival time) are
   - Interstitial lung abnormalitites (ILA) 
     Patients who have underlying lung disease with ILA shows 3 times higher risk than patients who have emphysema 
   - Age
     Patients that older than 60 years old have approximately 2 times higher risk than patients that younger than 60 years old
   - Size of tumor in central lung cancer patients (cT)
     Patients in criteria T2 (Tumor diameter 2.1-4 cm) and T3 (Tumor diameter 4.1-6 cm) have 2 and 3 times higher risk than patients with criteria T1 (Tumor diameter less than or equal to 0 cm), respectively.
    Note that no significant different between patient cT1 and cT4 maybe because we have little number of cT4 patients (n=15)
   - Nearby lymph nodes that are involved in peripheral lung cancer patients (pN)
     Peripheral lung cancer patients whom their cancers spread to lymph nodes within the lung or where the lung joins (N1), lymph nodes in the centre of the chest or under the windpipe brances off to each lung (N2), or lymph nodes on the opposite side of the chest from the affted lung or above the collar bone or at the top of the lung (N3) have approximately 2, 3 and 4 times higher risk than patients who show no nodal involvement.
   - Metastasis of peripheral lung cancer patients (pM)
     Peripheral lung cancer patients whom cancer spread to area outside the chest have 11 times higher risk than patients with no cancer spreading outside the lung
   - Metastasis 
     For both type of lung cancer, patients who have cancer spreading outside the lung have approximately twice higher risk than those without metastasis
   - FEV1/FVC ratio 
     Every increasing unit of FEV1/FVC ratio unit will also increase the risk with approximately 1%

   
3.  Features that lead to a statistical significant lower risk (Longer survival time) are  
   - No underlying lung disease
     Without underlying lung disease, patients have approximately 40% lower risk than patients with emphysema 
   - No smoking history
     Patients who do not smoke have 80% lower risk than patients who have unknown record about smoking

   
Bring all significant feature to make another candidate model
```{r}

lungSCC_multiCox_2 <- coxph(Surv(OS, death) ~ Underlying_lung + AG + cT+ pN+ pM + Smoking_state + FEV1_FVC +  meta , data = lungSCC)

summary(lungSCC_multiCox_2)

```
Interpretation:
The concordance score of this model is less than the previous one which means the first model is better. 

Since lungSCC_multiCox_2 is the nested model of lungSCC_multiCox, to compare both model we will use Likelihood Ratio Test (LRT)


Compaing nested model: LRT
```{r}
anova(lungSCC_multiCox_2, lungSCC_multiCox)
```
Interpretation:
Non significant p-value indicates that there is no significant different in the goodness of fit between these 2 models. 
Even lungSCC_multiCox model is more complex than lungSCC_multiCox_2 but it has higher concordance score, therefore; we will go for this one.


















