---
title: "Lung Cancer Prognosis"
author: "Lisa KOPPE, Khwansiri NINPAN, Princy PAPPACHAN"
date: "4/23/2020"
output: pdf_document
---

Paper:
[Integrated evaluation of clinical, pathological and radiological prognostic factors in squamous cell carcinoma of the lung ](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6777828/)

# Import the necessary packages:

```{r}
library(tidyverse)
library(survival)
library(survminer)
```

# Data preparation: load the lung cancer dataset and check data types

```{r}
# Note: Check only data type of columns that we want to work with since we have set the default for the remaining as c already

lungSCC_raw <- read_csv("LungCancer.csv",
                         col_types=cols(Sex='c',
                                       Age='c',
                                       Location='d',
                                       Obst_pn_or_plugging='d',
                                       Necrosis='d',
                                       Underlying_lung='d',
                                       Effusion='d',
                                       LN_ratio='d',
                                       cT='c',
                                       cN='c',
                                       cM='c',
                                       pT='c',
                                       pN='c',
                                       pM='c',
                                       Smoking_state='c',  
                                       FEV1_FVC='d',
                                       CEA='d',
                                       op_type='c',
                                       death='d',
                                       OP_site_recur='l',
                                       meta='l',
                                       OS = "d",
                                       .default = 'c'))
```

Explore the dataset
# Note: Be careful about the interpretation of this chunk
since some features are divided in class by number 
For example, Necrosis is divided into 3 classes; normal = 0, necrosis =  1, cavitization = 2
If we run this chunk we will get, mean of necrosis = 0.4171 >> Not the real data distribution of necrosis
Therefore, the summary is useful for columns with the real numerical data only (age for example)

To observe the distribution of features that use number to classify their classes, use command "table" as indicated in the next chunck of code

```{r}
names(lungSCC_raw)
str(lungSCC_raw)
dim(lungSCC_raw)
head(lungSCC_raw)
summary(lungSCC_raw)
```

Check null value and data classification for all 20 variables.
Use table for classification and Logical column to see how they distribute.
Count null value in decimal column (OS)

```{r}
table(lungSCC_raw$Location, useNA="always")
table(lungSCC_raw$death, useNA="always")


# Radiologic features
table(lungSCC_raw$Obst_pn_or_plugging, useNA="always")
table(lungSCC_raw$Necrosis, useNA="always")
table(lungSCC_raw$Underlying_lung, useNA="always")
table(lungSCC_raw$Effusion, useNA="always")

# Clinicopathologic features
table(lungSCC_raw$Sex, useNA="always")
table(lungSCC_raw$Age, useNA="always")
table(lungSCC_raw$LN_ratio, useNA="always")
table(lungSCC_raw$cT, useNA="always")
table(lungSCC_raw$cN, useNA="always")
table(lungSCC_raw$cM, useNA="always")
table(lungSCC_raw$pT, useNA="always")
table(lungSCC_raw$pN, useNA="always")
table(lungSCC_raw$pM, useNA="always")
table(lungSCC_raw$Smoking_state, useNA="always")
table(lungSCC_raw$FEV1_FVC, useNA="always")
table(lungSCC_raw$CEA, useNA="always")
table(lungSCC_raw$op_type, useNA="always")
table(lungSCC_raw$meta, useNA="always")
```

Define the meaning of each label to make it easier for interpretation

```{r}
lungSCC <- mutate(lungSCC_raw,
                  Location=ifelse(Location==0, "Peripheral","Central"),
                  
                  Necrosis=ifelse(Necrosis==0, "NoRemark",
                                  ifelse(Necrosis==1, "Necrosis", "Cavitization")),

                  Underlying_lung=ifelse(Underlying_lung==0, "NoRemark",
                                         ifelse(Underlying_lung==1, "Emphysema", "ILA")),
                  
                  Sex=factor(Sex, levels=c("F", "M")),
                  
                  AG=ifelse((Age<60), "LT60", "OV60"),
          
                  AG=factor(AG),
                
                  OP=factor(op_type, labels=c("lobectomy", "pneumonectomy", "segmentectomy", "LN biopsy", "No OP")),
                                                  
                  Smoking_state=factor(Smoking_state, labels=c("unknown", "current-smoker", "ex- smoker", "non- smoker")),
                  
                  cT=factor(cT, levels=c("1", "2", "3", "4"), labels=c("cT1", "cT2", "cT3", "cT4")),
                  
                  cN=factor(cN, levels=c("1", "2", "3", "4"), labels=c("cN0", "cN1", "cN2", "cN3")),
                  
                  cM=factor(cM, levels=c("1", "3"), labels=c("cM0", "cM1b")),
                  
                  pT=factor(pT, levels=c("1", "2", "3", "4"), labels=c("pT1", "pT2", "pT3", "pT4")),
                  
                  pN=factor(pN, levels=c("1", "2", "3", "4"), labels=c("pN0", "pN1", "pN2", "pN3")),
                  
                  pM=factor(pM, levels=c("1", "3"), labels=c("pM0", "pM1b")))
```

Recheck the distribution of age after regrouped
```{r}
table(lungSCC$AG)
```




# Features description

1. Location
   = tumor location
   (Class: 0=Peripheral SCC, 1=Central SCC)
   
2. death
   (Logical: 0=Alive, 1=Dead)
   
3. OS
   = Overall Survival in months: interval between the date of diagnosis and date of death (by any cause)

## Radiologic features:

4. Obst_pn_or_plugging
   = presence of obstructive pneumonitis/atelectais
   (Logical: 0=Absent, 1=Present)
   
5. Necrosis
   (Class: 0=Nothing, 1=Necrosis, 2=Cavitization)
   
6. Underlying_lung
   = underlying lung disease
   (Class: 0=No Remarkable, 1=Emphysema, 2=Interstitial lung abnormality)
   
7. Effusion
   (Logical: 0=Absent, 1=Present)

## Clinicopathologic features: 

8. Sex
   = gender of the patient
   (Class: F=Female, M=Male)
   
9. AG
   = age at diagnosis
   (Class: LT60 = Lower than 60 years old, OV60 = Over than 60 years old)
   
10. LN_ratio
    = lymph node ratio: number of nodes with positive tumor cells divided by the number of all resected nodes
    
11. cT
    = central / size of original tumor
    (Class: 1=T1, 2=T2, 3=T3, 4=T4)
    
12. cN
    = central / nearby lymph nodes involved
    (Class: 1=N0, 2=N1, 3=N2, 4=N3)
    
13. cM
    = central / distant metastasis (spread of cancer from one part of the body to another)
    (Class: 1=M0, 2=M1a, 3=M1b, 4=M1ab, 5=Mx)
    
14. pT
    = peripheral / size of original tumor
    (Class: 1=T1, 2=T2, 3=T3, 4=T4)
    
15. pN
    = peripheral / nearby lymph nodes involved
    (Class: 1=N0, 2=N1, 3=N2, 4=N3)
    
16. pM
    = peripheral / distant metastasis (spread of cancer from one part of the body to another)
    (Class: 1=M0, 2=M1a, 3=M1b, 4=M1ab, 5=Mx)
    
17. Smoking_state
    = current smoking state of the patient
    (Class: current-smoker, ex-smoker, non-smoker, unknown)
    
18. FEV1_FVC
    = pulmonary function test in %: forced expiratory volume in a second / forced vital capacity
    
19. CEA
    = serum carcinoembryonic antigen level in ng/ml (tumor marker)
    
20. OP
    = type of operation the person has undergone
    (Class: lobectomy, pneumonectomy, segmentectomy, LN biopsy, no Op)
    
21. meta
    = metastasis observed
    (Logical: 0=Absent, 1=Present)


# Part 1: Test relationship between radiologic/clinicopathologic features and death (not considering survival duration)

Methods used:
1. Fisher's exact test (determine the relationship between two categorical variables)
2. Logistic regression (determine the relationship between categorical continuous variables)

## Relationship between radiologic features and death

### Fisher's exact test

Determine the relationship between two categorical variables

Hypotheses:
H0: there is no relationship between the two categorical variables.
H1: the variables are dependent. Knowing the value of one variable helps to predict the value of the other variable.

Odds ratio:
Odds for death in patient with specific condition
divided by odds for death in patient without specific condition
If those 2 sets of patient have equal odds (odds ratio = 1), that specific condition are independent to death status

----
1. Difference in risk of death in patient with and without obstructive pneumonitis/ atelectais
2. Difference in risk of death in patient with and without lung effusion
----

1. Difference in risk of death in patient with and without obstructive pneumonitis/ atelectais:
```{r}
with(lungSCC, fisher.test(table(death, Obst_pn_or_plugging)))
```
Interpretation:
p-value is higher than the significance level of 5%, therefore; we cannot reject null hypothesis which means data not sufficient to prove that obstructive pneumonitis/ atelectais effect the death.

Odds ratio suggests that patients with obstructive pneumonitis/ atelectais have approximately 19% lower risk of death than that of patient without obstructive pneumonitis/ atelectais
See that 95% confidence interval ranges from 0.54, where patients with pneumonitis/atelectais have around 5% lower risk of death than patients without this condition, to 1.24 which means they have 24% higher risk of death than another group of patient.
(Correlate with publication, this feature is suprisingly improve the survival time)


2. Difference in risk of death in patient with and without lung effusion:
```{r}
with(lungSCC, fisher.test(table(death, Effusion)))
```
Interpretation:
No relationship between death and lung effusion (p-value = 1)
Patients with lung effusion have 5% higher risk of death than patients without lung effusion

3. Difference in risk of death in patient with Age less than and over 60:
```{r}
with(lungSCC, fisher.test(table(death, AG)))
```
Interpretation:
With p-value = 0.002378 less than the significance level, we can reject null hypothsis and can conclue that person with age more than 60 years have 4 times higher chances of dying than the younger people

4. Difference in risk of death in patient based on gender
```{r}
with(lungSCC, fisher.test(table(death, Sex)))

```
Interpretation:
As the p-value is 0.5974 , we can conclude that chances of death is independent of gender 

### Logistic regression

Determine the relationship between categorical continuous variables

----
1. Difference in risk of death based on cancer location
2. Difference in risk of death based on cell necrosis
3. Difference in risk of death based on underlying lung disease
----

1. Difference in risk of death based on cancer location:
```{r}
fit <- glm(death~Location, family="binomial", data=lungSCC)
summary(fit)
```
Interpretation:
1. No significant relationship between location of lung cancer and the prediction of death status.
2. The positive value of estimate coefficient indicates the positive relationship between peripheral lung cancer and risk of death.
3. Odds of peripheral lung cancer is lower than odds of central lung cancer. 
To see the odds ratio between these 2 conditions, we have to exponent this coefficients (see belows).

```{r}
exp(0.2749)
```
Interpretation:
Risk of death of patients who have peripheral lung cancer is around 30% higher than patients with central lung cancer


2. Difference in risk of death based on cell necrosis:
```{r}
fit <- glm(death~Necrosis, family="binomial", data=lungSCC)
summary(fit)
```
Interpretation:
1. No cell necrosis observation shows significantly negative effect in the prediction of death in lung cancer patients with p-value 0.0248 (i.e No necrosis reduces risk of death).
2. Odds of cell necrosis and invisible cell necrosis are lower than that of cavitization in lung

```{r}
exp(-0.7482)
exp(-0.9776)
```
Interpretation:
Risk of death of lung cancer patients who have necrosis and invisible cell necrosis are around 53% and  63% lower than patients with cavitization.


3. Difference in risk of death based on underlying lung disease:
```{r}
fit <- glm(death~Underlying_lung, family="binomial", data=lungSCC)
summary(fit)
```
Interpretation:
1. Interstitial lung abnormalities (ILA) shows significantly positive relationship with the risk of death with p-value 0.007.
2. No underlying lung disease has statistically significant negative relationship with the risk of death with p-value 0.09
2. Odd of ILA is higher than that of emphysema while odd of negative underlying lung disease is lower than odd of patients with emphysema. 

```{r}
exp(1.81475)
exp(-0.45911)
```
Interpretation:
Risk of death of lung cancer patients with ILA is almost 6 times higher than patient with emphysema while risk of death of no underlying lung disease patients is 40% lower than patients with emphysema.


## Relationship between clinicopathologic features and death

### Fisher's exact test

Determine the relationship between two categorical variables

Hypotheses:
H0: there is no relationship between the two categorical variables.
H1: the variables are dependent. Knowing the value of one variable helps to predict the value of the other variable.

Odds ratio:
Odds for death in patient with specific condition
divided by odds for death in patient without specific condition
If those 2 sets of patient have equal odds (odds ratio = 1), that specific condition are independent to death status

----
X. Difference in risk of death in patient with and without observed metastasis after surgery (meta)
----

X. Difference in risk of death in patient with and without observed metastasis after surgery (meta):
```{r}
with(lungSCC, table(death, meta))
with(lungSCC, fisher.test(table(death, meta)))
```
Interpretation:
The p-value is way lower than the significant level of 5% (p-value = 8.52e-10) the variables are closely dependent. Data is sufficient to prove that the observation of metastasis after surgery increases the risk leading to death.
We can then reject the null hypothesis.

The odds ratio (3.65) suggests that patients with observed metastasis after surgery have approximately 265% higher risk of death than patients without any metastasis observed.
95% confidence interval ranges from 2.35 to 5.72.


### Logistic regression

Determine the relationship between categorical continuous variables

----
X. Difference in risk of death based on lymph node ratio
X. Difference in risk of death based on pT peripheral tumor size
X. Difference in risk of death based on pN peripheral tumor size
X. Difference in risk of death based on pM peripheral tumor size
X. Difference in risk of death based on FEV1_FVC pulmonary function test
X. Difference in risk of death based on CEA serum
----

X. Difference in risk of death based on lymph node ratio:
```{r}
with(lungSCC, table(death, LN_ratio))

fit <- glm(death~LN_ratio, family="binomial", data=lungSCC)
summary(fit)

exp(confint(glm(death~LN_ratio, family="binomial", data=lungSCC))[2,])
```
Interpretation:
1. The coefficient is positive (1.38) which means that there is a positive association between the lymph node ratio and the risk of death.
2. p-value (0.02) remains small so this relationship is slightly significant.
3. Odds ratio doen't give any information here because of the continuous type of this variable.

```{r}
# TRY TO SPLIT INTO RANGES
fit <- glm(death~I(LN_ratio/4), family="binomial", data=lungSCC)
summary(fit)

exp(confint(glm(death~I(LN_ratio/4), family="binomial", data=lungSCC))[2,])
```

```{r}
exp(5.5298)
```
Interpretation: odds ratio


X. Difference in risk of death based on pT peripheral tumor size:
```{r}
with(lungSCC, table(death, pT))

fit <- glm(death~pT, family="binomial", data=lungSCC)
summary(fit)

exp(confint(glm(death~pT, family="binomial", data=lungSCC))[2,])
```
Interpretation:
1. pT3 tumor size shows significantly positive relationship with the risk of death with p-value 0.005.

```{r}
exp(0.4370)
exp(0.9622)
exp(1.2672)
```
Interpretation:
1. The risk of death of patients who have a tumor of pT2 size type is 55% higher than for patients whose tumor has pT1 size type.
2. The risk of death of patients who have a tumor of pT3 size type is 162% higher than for patients whose tumor has pT1 size type.
3. The risk of death of patients who have a tumor of pT4 size type is 255% higher than for patients whose tumor has pT1 size type.


X. Difference in risk of death based on pN peripheral tumor size:
```{r}
with(lungSCC, table(death, pN))

fit <- glm(death~pN, family="binomial", data=lungSCC)
summary(fit)

exp(confint(glm(death~pN, family="binomial", data=lungSCC))[2,])
```
Interpretation:
1. pN2 tumor size shows a highly significant positive relationship with the risk of death with p-value 0.0003.

```{r}
exp(0.2224)
exp(1.1628)
exp(1.5965)
```
Interpretation:
1. The risk of death of patients who have a tumor of pN1 size type is 25% higher than for patients whose tumor has pN0 size type.
2. The risk of death of patients who have a tumor of pN2 size type is 220% higher than for patients whose tumor has pN0 size type.
3. The risk of death of patients who have a tumor of pN3 size type is 393% higher than for patients whose tumor has pN0 size type.


X. Difference in risk of death based on pM peripheral tumor size:
```{r}
with(lungSCC, table(death, pM))

fit <- glm(death~pM, family="binomial", data=lungSCC)
summary(fit)

exp(confint(glm(death~pM, family="binomial", data=lungSCC))[2,])
```
Interpretation:
1. There is no relationship between the pM tumor size and the prediction of death status (p-value = 0.98).

```{r}
exp(15.8626)
```


X. Difference in risk of death based on FEV1_FVC pulmonary function test:
```{r}
with(lungSCC, table(death, FEV1_FVC))

fit <- glm(death~FEV1_FVC, family="binomial", data=lungSCC)
summary(fit)

exp(confint(glm(death~FEV1_FVC, family="binomial", data=lungSCC))[2,])
```
Interpretation:
1. There is no significant relationship between the pulmonary function test FEV1_FVC and the prediction of death status (p-value = 0.21).
2. Odds ratio doen't give any information here because of the continuous type of this variable.

```{r}
exp(0.011147)
```


X. Difference in risk of death based on CEA serum:
```{r}
with(lungSCC, table(death, CEA))

fit <- glm(death~CEA, family="binomial", data=lungSCC)
summary(fit)

exp(confint(glm(death~CEA, family="binomial", data=lungSCC))[2,])
```
Interpretation:
1. There is no significant relationship between the CEA serum and the prediction of death status (p-value = 0.58).
2. Odds ratio doen't give any information here because of the continuous type of this variable.

```{r}
exp(-0.003081)
```

Difference in risk of death based on Operation undergone : 
```{r}
summary(glm(death ~ OP, data = lungSCC, family = "binomial"))

```

```{r}
exp(2.0974)

```
Interpretation :
1.We can see that No operation ,pneumonectomy and PLN biopsy has postive effect on death while segmentectomy has negative effect 
2.LN biopsy has significant relation with the prediction of death with p-value : 0.006946
3. The odds ratio states that person who has undergone  LN biopsyhas 714% chances of death as compared to person undergone lobectomy 



Difference in risk of death based on smoking state : 
```{r}
summary(glm(death ~ Smoking_state, data = lungSCC, family = "binomial"))


```
Interpretation : 
1.Being a current smoker , ex smoker and non smoker has negative association with death .
2.No significant relation between Smoking State and death

Difference in risk of death based on Central Lung SCC size of Tumor : 
```{r}
summary(glm(death ~ cT, data = lungSCC, family = "binomial"))

```

```{r}
exp(0.5702)

exp(1.4731)

exp(1.3122)
```
Interpretations: 
1. All the tumor size have positive association with the risk of death
2. Tumor size T2 has 76% more chances of death as compaed to T1
3. Tumor size T3 has 336% more chances of death as compaed to T1
4. Tumor size T4 has 271% more chances of death as compaed to T1
5. Patient with Central SSC tumor size of T3 has the highest risk of death 



Difference in risk of death when Nearby lymph nodes that are involved : 
```{r}
summary(glm(death ~ cN, data = lungSCC, family = "binomial"))

```


```{r}
exp(0.5702)

exp(1.4731)

exp(1.3122)

```


Interpretations: 
1.All the tumor size have positive association with the risk of death
2. Proximity of N1 lymph nodes has 76% more chances of death as compared to N0
3. Proximity of N2 lymph nodes has 336% more chances of death as compared to N0
4. Proximity of N3 lymph nodes has 271% more chances of death as compared to N0
5. Patient with Proximity of N2 lymph nodes has the highest risk of death 



Difference in risk of death when Distant metastasis (spread of cancer from one part of the body to another) are involved : 
```{r}
summary(glm(death ~ cM, data = lungSCC, family = "binomial"))


```

```{r}
exp(0.2744)
```
Interpretations:
1.All Distant metastasis  have positive association with the risk of death
2.M3 Distant metastasis  has 31 % higher chances of risk of death as compared to M1 


# Part 2: Test relationship between radiologic/clinicopathologic features and survival time (OS)

Methods used: Cox Proportional Hazards Model

## Relationship between radiologic features and survival time (OS)

----
1. patient with and without obstructive pneumonitis/ atelectais
2. patient with and without lung effusion
3. cancer location
4. cell necrosis
5. underlying lung disease
----

1. patient with and without obstructive pneumonitis/ atelectais
```{r}

```
Interpretation

2. patient with and without lung effusion
```{r}
fit_effusion <- coxph(Surv(OS, death)~Effusion, data=lungSCC)
summary(fit_effusion)
```
Interpretation

3. cancer location
```{r}

```
Interpretation

4. cell necrosis
```{r}

```
Interpretation

5. underlying lung disease
```{r}
fit_UndLung <- coxph(Surv(OS, death)~Underlying_lung, data=lungSCC)
summary(fit_UndLung)
```
Interpretation


## Relationship between clinicopathologic features and survival time (OS)

----
X. patient with and without observed metastasis after surgery (meta)
X. lymph node ratio
X. pT peripheral tumor size
X. pN peripheral tumor size
X. pM peripheral tumor size
X. FEV1_FVC pulmonary function test
X. CEA serum
----

X. patient with and without observed metastasis after surgery (meta)
```{r}
fit_meta <- coxph(Surv(OS, death)~meta, data=lungSCC)
summary(fit_meta)
```
Interpretation

X. lymph node ratio
```{r}
fit_LNratio <- coxph(Surv(OS, death)~LN_ratio, data=lungSCC)
summary(fit_LNratio)
```
Interpretation

X. pT peripheral tumor size
```{r}
fit_pT <- coxph(Surv(OS, death)~pT, data=lungSCC)
summary(fit_pT)
```
Interpretation

X. pN peripheral tumor size
```{r}
fit_pN <- coxph(Surv(OS, death)~pN, data=lungSCC)
summary(fit_pN)
```
Interpretation

X. pM peripheral tumor size
```{r}
fit_pM <- coxph(Surv(OS, death)~pM, data=lungSCC)
summary(fit_pM)
```
Interpretation

X. FEV1_FVC pulmonary function test
```{r}
fit_FEV1FVC <- coxph(Surv(OS, death)~FEV1_FVC, data=lungSCC)
summary(fit_FEV1FVC)
```
Interpretation

X. CEA serum
```{r}
fit_CEA <- coxph(Surv(OS, death)~CEA, data=lungSCC)
summary(fit_CEA)
```
Interpretation


# Part 3: Kaplan-Meyer estimator with features which have a significant relationship with survival time (OS)
(Only when n of each gr kind of similar)

## Comparison between 2 groups of patients based on observed metastasis after surgery

```{r}
fit.KM_meta <- survfit(Surv(OS, death)~meta, data=lungSCC)
fit.KM_meta
```
Interpretation

```{r}
ggsurvplot(fit.KM_meta,
           legend = "bottom",
           conf.int = TRUE,
           linetype = "strata",
           legend.title = "Observation of metastasis",
           xlab = "Months",
           ylab = "Survival probability")
```
