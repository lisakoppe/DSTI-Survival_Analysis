---
title: "Lung Cancer Prognosis"
author: "Lisa KOPPE, Khwansiri NINPAN, Princy PAPPACHAN"
date: "4/23/2020"
output: word_document
---

Paper:
[Integrated evaluation of clinical, pathological and radiological prognostic factors in squamous cell carcinoma of the lung](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6777828/)

# Import the necessary packages:

```{r}
library(tidyverse)
library(survival)
library(survminer)
```

# Data preparation: load the lung cancer dataset and check data types

```{r}

# Check data types only columns we want to work with
# Set default as c for the rest

lungSCC_raw <- read_csv("LungCancer.csv",
                         col_types=cols(Sex='c',
                                       Age='d',
                                       Location='d',
                                       Obst_pn_or_plugging='d',
                                       Necrosis='d',
                                       Underlying_lung='d',
                                       Effusion='d',
                                       LN_ratio='d',
                                       cT='d',
                                       cN='d',
                                       cM='d',
                                       pT='d',
                                       pN='d',
                                       pM='d',
                                       Smoking_state='d',  
                                       FEV1_FVC='d',
                                       CEA='d',
                                       op_type='d',
                                       death='d',
                                       meta='d',
                                       OS = "d",
                                       .default = 'c'))
```

# Explore the dataset: 
    - For classification data, use "table" 
    - For numerical data: use "table" + "summary" 
      (Summary to define basic descriptive statistic, Table to check null value)

```{r}
dim(lungSCC_raw)  # Check total patients + columns 


# Radiologic features
table(lungSCC_raw$Location, useNA="always")
table(lungSCC_raw$Obst_pn_or_plugging, useNA="always")
table(lungSCC_raw$Necrosis, useNA="always")
table(lungSCC_raw$Underlying_lung, useNA="always")
table(lungSCC_raw$Effusion, useNA="always")

# Clinicopathologic features
table(lungSCC_raw$Sex, useNA="always")
table(lungSCC_raw$Age, useNA="always")
summary(lungSCC_raw$Age)
table(lungSCC_raw$LN_ratio, useNA="always")
summary(lungSCC_raw$LN_ratio)
table(lungSCC_raw$cT, useNA="always")
table(lungSCC_raw$cN, useNA="always")
table(lungSCC_raw$cM, useNA="always")
table(lungSCC_raw$pT, useNA="always")
table(lungSCC_raw$pN, useNA="always")
table(lungSCC_raw$pM, useNA="always")
table(lungSCC_raw$Smoking_state, useNA="always")
table(lungSCC_raw$FEV1_FVC, useNA="always")
summary(lungSCC_raw$FEV1_FVC)
table(lungSCC_raw$CEA)
summary(lungSCC_raw$CEA)
table(lungSCC_raw$op_type, useNA="always")
table(lungSCC_raw$death, useNA="always")
table(lungSCC_raw$meta, useNA="always")
table(lungSCC_raw$OS, useNA="always")
summary(lungSCC_raw$OS)
```


Redefine the meaning of each label to make it easier for interpretation


```{r}

lungSCC <- mutate(lungSCC_raw,
                  Location=ifelse(Location==0, "Peripheral","Central"),
                  
                  Necrosis=ifelse(Necrosis==0, "NoRemark",
                                  ifelse(Necrosis==1, "Necrosis", "Cavitization")),

                  Underlying_lung=ifelse(Underlying_lung==0, "NoRemark",
                                         ifelse(Underlying_lung==1, "Emphysema", "ILA")),
                  AG = ifelse((Age < 60), "LT60", "OV60"),
          
                  AG = factor(AG),
                
                  OP = factor(op_type,labels = c("lobectomy","pneumonectomy","segmentectomy","LN biopsy","No OP")),
                 
                  Smoking_state = factor(Smoking_state,labels = c("unknown","current-smoker","ex- smoker", "non- smoker")),
                  
                  cT = factor(cT, levels = c("1", "2", "3", "4"), labels = c("cT1", "cT2", "cT3", "cT4")),
                  
                  cN = factor(cN, levels = c("1", "2", "3", "4"), labels = c("cN0", "cN1", "cN2", "cN3")),
                  
                  cM = factor(cM, levels = c("1", "3"), labels = c("cM0", "cM1b")),
                  
                  pT = factor(pT, levels = c("1", "2", "3", "4"), labels = c("pT1", "pT2", "pT3", "pT4")),
                  
                  pN = factor(pN, levels = c("1", "2", "3", "4"), labels = c("pN0", "pN1", "pN2", "pN3")),
                  
                  pM = factor(pM, levels = c("1", "3"), labels = c("pM0", "pM1b")))
```


Recheck the distribution of age after regrouped
```{r}
table(lungSCC$AG)
```




# Features description

1. Location
   = tumor location
   (Class: 0=Peripheral SCC, 1=Central SCC)
   
2. death
   (Logical: 0=Alive, 1=Dead)
   
3. OS
   = Overall Survival in months: interval between the date of diagnosis and date of death (by any cause)

## Radiologic features:

4. Obst_pn_or_plugging
   = presence of obstructive pneumonitis/atelectais
   (Logical: 0=Absent, 1=Present)
   
5. Necrosis
   (Class: 0=Nothing, 1=Necrosis, 2=Cavitization)
   
6. Underlying_lung
   = underlying lung disease
   (Class: 0=No Remarkable, 1=Emphysema, 2=Interstitial lung abnormality)
   
7. Effusion
   (Logical: 0=Absent, 1=Present)

## Clinicopathologic features: 

8. Sex
   = gender of the patient
   (Class: F=Female, M=Male)
   
9. AG
   = age at diagnosis
   (Class: LT60 = Lower than 60 years old, OV60 = Over than 60 years old)
   
10. LN_ratio
    = lymph node ratio: number of nodes with positive tumor cells divided by the number of all resected nodes
    
11. cT
    = central / size of original tumor
    (Class: 1=T1, 2=T2, 3=T3, 4=T4)
    
12. cN
    = central / nearby lymph nodes involved
    (Class: 1=N0, 2=N1, 3=N2, 4=N3)
    
13. cM
    = central / distant metastasis (spread of cancer from one part of the body to another)
    (Class: 1=M0, 2=M1a, 3=M1b, 4=M1ab, 5=Mx)
    
14. pT
    = peripheral / size of original tumor
    (Class: 1=T1, 2=T2, 3=T3, 4=T4)
    
15. pN
    = peripheral / nearby lymph nodes involved
    (Class: 1=N0, 2=N1, 3=N2, 4=N3)
    
16. pM
    = peripheral / distant metastasis (spread of cancer from one part of the body to another)
    (Class: 1=M0, 2=M1a, 3=M1b, 4=M1ab, 5=Mx)
    
17. Smoking_state
    = current smoking state of the patient
    (Class: current-smoker, ex-smoker, non-smoker, unknown)
    
18. FEV1_FVC
    = pulmonary function test in %: forced expiratory volume in a second / forced vital capacity
    
19. CEA
    = serum carcinoembryonic antigen level in ng/ml (tumor marker)
    
20. OP
    = type of operation the person has undergone
    (Class: lobectomy, pneumonectomy, segmentectomy, LN biopsy, no Op)
    
21. meta
    = metastasis observed
    (Logical: 0=Absent, 1=Present)


*# Part 1: Test relationship between radiologic/clinicopathologic features and death (not considering survival duration)*

Methods used:
1. Fisher's exact test (determine the relationship between two categorical variables)
2. Logistic regression (determine the relationship between categorical continuous variables)

## Relationship between radiologic features and death

### Fisher's exact test

Determine the relationship between two categorical variables

Hypotheses:
H0: there is no relationship between the two categorical variables.
H1: the variables are dependent. Knowing the value of one variable helps to predict the value of the other variable.

Odds ratio:
Odds for death in patient with specific condition
divided by odds for death in patient without specific condition
If those 2 sets of patient have equal odds (odds ratio = 1), that specific condition are independent to death status

----
1. Difference in risk of death in patient with and without obstructive pneumonitis/ atelectais
2. Difference in risk of death in patient with and without lung effusion
----


1. Difference in risk of death in patient with and without obstructive pneumonitis/ atelectais:
```{r}
with(lungSCC, fisher.test(table(death, Obst_pn_or_plugging)))
```
Interpretation:
p-value is higher than the significance level of 5%, therefore; we cannot reject null hypothesis which means data not sufficient to prove that obstructive pneumonitis/ atelectais effect the death.

Odds ratio suggests that patients with obstructive pneumonitis/ atelectais have approximately 19% lower risk of death than that of patient without obstructive pneumonitis/ atelectais
See that 95% confidence interval ranges from 0.54, where patients with pneumonitis/atelectais have around 5% lower risk of death than patients without this condition, to 1.24 which means they have 24% higher risk of death than another group of patient.
(Correlate with publication, this feature is suprisingly improve the survival time)


2. Difference in risk of death in patient with and without lung effusion:
```{r}
with(lungSCC, fisher.test(table(death, Effusion)))
```
Interpretation:
No relationship between death and lung effusion (p-value = 1)
Patients with lung effusion have 5% higher risk of death than patients without lung effusion


### Logistic regression

Determine the relationship between categorical continuous variables

----
1. Difference in risk of death based on cancer location
2. Difference in risk of death based on cell necrosis
3. Difference in risk of death based on underlying lung disease
----


1. Difference in risk of death based on cancer location:
```{r}
fit <- glm(death~Location, family="binomial", data=lungSCC)
summary(fit)
```
Interpretation:
1. No significant relationship between location of lung cancer and the prediction of death status.
2. The positive value of estimate coefficient indicates the positive relationship between peripheral lung cancer and risk of death.
3. Odds of peripheral lung cancer is lower than odds of central lung cancer. 
To see the odds ratio between these 2 conditions, we have to exponent this coefficients (see belows).

```{r}
exp(0.2749)
```
Interpretation:
Risk of death of patients who have peripheral lung cancer is around 30% higher than patients with central lung cancer


2. Difference in risk of death based on cell necrosis:
```{r}
fit <- glm(death~Necrosis, family="binomial", data=lungSCC)
summary(fit)
```
Interpretation:
1. No cell necrosis observation shows significantly negative effect in the prediction of death in lung cancer patients with p-value 0.0248 (i.e No necrosis reduces risk of death).
2. Odds of cell necrosis and invisible cell necrosis are lower than that of cavitization in lung

```{r}
exp(-0.7482)
exp(-0.9776)
```
Interpretation:
Risk of death of lung cancer patients who have necrosis and invisible cell necrosis are around 53% and  63% lower than patients with cavitization.


3. Difference in risk of death based on underlying lung disease:
```{r}
fit <- glm(death~Underlying_lung, family="binomial", data=lungSCC)
summary(fit)
```
Interpretation:
1. Interstitial lung abnormalities (ILA) shows significantly positive relationship with the risk of death with p-value 0.007.
2. No underlying lung disease has statistically significant negative relationship with the risk of death with p-value 0.09
2. Odd of ILA is higher than that of emphysema while odd of negative underlying lung disease is lower than odd of patients with emphysema. 

```{r}
exp(1.81475)
exp(-0.45911)
```
Interpretation:
Risk of death of lung cancer patients with ILA is almost 6 times higher than patient with emphysema while risk of death of no underlying lung disease patients is 40% lower than patients with emphysema.


## Relationship between clinicopathologic features and death

### Fisher's exact test

Determine the relationship between two categorical variables

Hypotheses:
H0: there is no relationship between the two categorical variables.
H1: the variables are dependent. Knowing the value of one variable helps to predict the value of the other variable.

Odds ratio:
Odds for death in patient with specific condition
divided by odds for death in patient without specific condition
If those 2 sets of patient have equal odds (odds ratio = 1), that specific condition are independent to death status

----
1. Difference in risk of death in patient based on gender
2. Difference in risk of death in patient with an age lower or greater than 60
3. Difference in risk of death in patient with and without observed metastasis after surgery (meta)
----


1. Difference in risk of death in patient based on gender:
```{r}
with(lungSCC, fisher.test(table(death, Sex)))
```
Interpretation:
As the p-value is 0.5974 , we can conclude that chances of death is independent of gender 


2. Difference in risk of death in patient with Age less than and over 60:
```{r}
with(lungSCC, fisher.test(table(death, AG)))
```
Interpretation:
With p-value = 0.002378 less than the significance level, we can reject null hypothsis and can conclue that person with age more than 60 years have 4 times higher chances of dying than the younger people


3. Difference in risk of death in patient with and without observed metastasis after surgery (meta):
```{r}
with(lungSCC, table(death, meta))
with(lungSCC, fisher.test(table(death, meta)))
```
Interpretation:
The p-value is way lower than the significant level of 5% (p-value = 8.52e-10) the variables are closely dependent. Data is sufficient to prove that the observation of metastasis after surgery increases the risk leading to death.
We can then reject the null hypothesis.

The odds ratio (3.65) suggests that patients with observed metastasis after surgery have approximately 265% higher risk of death than patients without any metastasis observed.
95% confidence interval ranges from 2.35 to 5.72.


### Logistic regression

Determine the relationship between categorical continuous variables

----
1. Difference in risk of death based on lymph node ratio
2. Difference in risk of death based on cT Central Lung SCC size of Tumor
3. Difference in risk of death based on cN when nearby lymph nodes are involved
4. Difference in risk of death based on cM when distant metastasis are involved
5. Difference in risk of death based on pT Peripheral Lung SCC size of Tumor
6. Difference in risk of death based on pN when nearby lymph nodes are involved
7. Difference in risk of death based on pM when distant metastasis are involved
8. Difference in risk of death based on the smoking state
9. Difference in risk of death based on FEV1_FVC pulmonary function test
10. Difference in risk of death based on CEA serum
11. Difference in risk of death based on the type of operation undergone
----

1. Difference in risk of death based on lymph node ratio:
```{r}
with(lungSCC, table(death, LN_ratio))

fit <- glm(death~LN_ratio, family="binomial", data=lungSCC)
summary(fit)

exp(confint(glm(death~LN_ratio, family="binomial", data=lungSCC))[2,])
```
Interpretation:
1. The coefficient is positive (1.38) which means that there is a positive association between the lymph node ratio and the risk of death.
2. p-value (0.02) remains small so this relationship is slightly significant.
3. Odds ratio doen't give any information here because of the continuous type of this variable.

```{r}
exp(1.38)
```
Interpretation: odds ratio


2. Difference in risk of death based on cT Central Lung SCC size of Tumor: 
```{r}
summary(glm(death ~ cT, data = lungSCC, family = "binomial"))
```

```{r}
exp(0.5702)
exp(1.4731)
exp(1.3122)
```
Interpretations: 
1. All the tumor size have positive association with the risk of death
2. Tumor size T2 has 76% more chances of death as compaed to T1
3. Tumor size T3 has 336% more chances of death as compaed to T1
4. Tumor size T4 has 271% more chances of death as compaed to T1
5. Patient with Central SSC tumor size of T3 has the highest risk of death 


3. Difference in risk of death based on cN when nearby lymph nodes are involved:
```{r}
summary(glm(death ~ cN, data = lungSCC, family = "binomial"))
```

```{r}
exp(0.5702)
exp(1.4731)
exp(1.3122)
```
Interpretations: 
1.All the tumor size have positive association with the risk of death
2. Proximity of N1 lymph nodes has 76% more chances of death as compared to N0
3. Proximity of N2 lymph nodes has 336% more chances of death as compared to N0
4. Proximity of N3 lymph nodes has 271% more chances of death as compared to N0
5. Patient with Proximity of N2 lymph nodes has the highest risk of death 


4. Difference in risk of death based on cM when distant metastasis (spread of cancer from one part of the body to another) are involved: 
```{r}
summary(glm(death ~ cM, data = lungSCC, family = "binomial"))
```

```{r}
exp(0.2744)
```
Interpretations:
1.All Distant metastasis  have positive association with the risk of death
2.M3 Distant metastasis  has 31 % higher chances of risk of death as compared to M1 


5. Difference in risk of death based on pT Peripheral Lung SCC size of Tumor:
```{r}
with(lungSCC, table(death, pT))

fit <- glm(death~pT, family="binomial", data=lungSCC)
summary(fit)

exp(confint(glm(death~pT, family="binomial", data=lungSCC))[2,])
```
Interpretation:
1. pT3 tumor size shows significantly positive relationship with the risk of death with p-value 0.005.

```{r}
exp(0.4370)
exp(0.9622)
exp(1.2672)
```
Interpretation:
1. The risk of death of patients who have a tumor of pT2 size type is 55% higher than for patients whose tumor has pT1 size type.
2. The risk of death of patients who have a tumor of pT3 size type is 162% higher than for patients whose tumor has pT1 size type.
3. The risk of death of patients who have a tumor of pT4 size type is 255% higher than for patients whose tumor has pT1 size type.


6. Difference in risk of death based on pN when nearby lymph nodes are involved:
```{r}
with(lungSCC, table(death, pN))

fit <- glm(death~pN, family="binomial", data=lungSCC)
summary(fit)

exp(confint(glm(death~pN, family="binomial", data=lungSCC))[2,])
```
Interpretation:
1. pN2 tumor size shows a highly significant positive relationship with the risk of death with p-value 0.0003.

```{r}
exp(0.2224)
exp(1.1628)
exp(1.5965)
```
Interpretation:
1. The risk of death of patients who have a tumor of pN1 size type is 25% higher than for patients whose tumor has pN0 size type.
2. The risk of death of patients who have a tumor of pN2 size type is 220% higher than for patients whose tumor has pN0 size type.
3. The risk of death of patients who have a tumor of pN3 size type is 393% higher than for patients whose tumor has pN0 size type.


4. Difference in risk of death based on pM when distant metastasis (spread of cancer from one part of the body to another) are involved:
```{r}
with(lungSCC, table(death, pM))

fit <- glm(death~pM, family="binomial", data=lungSCC)
summary(fit)

exp(confint(glm(death~pM, family="binomial", data=lungSCC))[2,])
```
Interpretation:
1. There is no relationship between the pM tumor size and the prediction of death status (p-value = 0.98).

```{r}
exp(15.8626)
```


8. Difference in risk of death based on the smoking state:
```{r}
summary(glm(death ~ Smoking_state, data = lungSCC, family = "binomial"))
```
Interpretation : 
1.Being a current smoker , ex smoker and non smoker has negative association with death .
2.No significant relation between Smoking State and death


9. Difference in risk of death based on FEV1_FVC pulmonary function test:
```{r}
with(lungSCC, table(death, FEV1_FVC))

fit <- glm(death~FEV1_FVC, family="binomial", data=lungSCC)
summary(fit)

exp(confint(glm(death~FEV1_FVC, family="binomial", data=lungSCC))[2,])
```
Interpretation:
1. There is no significant relationship between the pulmonary function test FEV1_FVC and the prediction of death status (p-value = 0.21).
2. Odds ratio doen't give any information here because of the continuous type of this variable.

```{r}
exp(0.011147)
```


10. Difference in risk of death based on CEA serum:
```{r}
with(lungSCC, table(death, CEA))

fit <- glm(death~CEA, family="binomial", data=lungSCC)
summary(fit)

exp(confint(glm(death~CEA, family="binomial", data=lungSCC))[2,])
```
Interpretation:
1. There is no significant relationship between the CEA serum and the prediction of death status (p-value = 0.58).
2. Odds ratio doen't give any information here because of the continuous type of this variable.

```{r}
exp(-0.003081)
```


11. Difference in risk of death based on the type of operation undergone:
```{r}
summary(glm(death ~ OP, data = lungSCC, family = "binomial"))

```

```{r}
exp(2.0974)

```
Interpretation :
1.We can see that No operation ,pneumonectomy and PLN biopsy has postive effect on death while segmentectomy has negative effect 
2.LN biopsy has significant relation with the prediction of death with p-value : 0.006946
3. The odds ratio states that person who has undergone  LN biopsyhas 714% chances of death as compared to person undergone lobectomy 


*# Part 2: Test relationship between radiologic/clinicopathologic features and survival time (OS)*

### Kaplan-Meyer estimator 

Overall survival estimation

```{r}
fit.KM <- survfit(Surv(OS, death) ~ 1, data = lungSCC)
fit.KM
```
Interpretation:
From total 398 patients, 172  (43%) were death 
Half of lung cancer patient will death within 103 months
RECHECK HOW TO INTERPREAT MEDIAN and KM plot WITH CENSORING DATA 


```{r}
ggsurvplot(fit.KM, 
           legend.title = "Survival", 
           xlab = "Months",  
           ylab = "Survival probability")
```



Methods used: Cox Proportional Hazards Model

## Relationship between radiologic features and survival time (OS)

----
1. patient with and without obstructive pneumonitis/ atelectais
2. patient with and without lung effusion
3. cell necrosis
4. underlying lung disease
----

1. patient with and without obstructive pneumonitis/ atelectais
```{r}

```
Interpretation

2. patient with and without lung effusion
```{r}
fit_effusion <- coxph(Surv(OS, death)~Effusion, data=lungSCC)
summary(fit_effusion)
```
Interpretation:
With a p-value close to 1 (0.92) we can assume that there is no significant relationship between survival time and lung effusion.

3. cell necrosis
```{r}

```
Interpretation

4. underlying lung disease
```{r}
fit_UndLung <- coxph(Surv(OS, death)~Underlying_lung, data=lungSCC)
summary(fit_UndLung)
```
Interpretation:
1. With a very low p-value of 1.95e-05 and a positive coefficient of 1.21, we can assume that there is a highly significant positive relationship between survival time and Interstitial lung abnormalities (ILA).
2. No underlying lung disease has a statistically significant negative relationship with the survival time with a p-value of 0.02.


## Relationship between clinicopathologic features and survival time (OS)

----
1. Sex
2. Age
3. lymph node ratio
4. cT Central Lung SCC size of Tumor
5. cN when nearby lymph nodes are involved
6. cM when distant metastasis are involved
7. pT Peripheral Lung SCC size of Tumor
8. pN when nearby lymph nodes are involved
9. pM when distant metastasis are involved
10. smoking state
11. FEV1_FVC pulmonary function test
12. CEA serum
13. the type of operation undergone
14. patient with and without observed metastasis after surgery (meta)
----


1. Sex:


2. Age:


3. lymph node ratio:
```{r}
fit_LNratio <- coxph(Surv(OS, death)~LN_ratio, data=lungSCC)
summary(fit_LNratio)
```
Interpretation:
With a positive coefficient of 0.84 and low p-value of 0.009, we can assume that there is a significant positive relationship between survival time and the lymph node ratio.


4. cT Central Lung SCC size of Tumor:


5. cN when nearby lymph nodes are involved:


6. cM when distant metastasis are involved:


7. pT Peripheral Lung SCC size of Tumor:
```{r}
fit_pT <- coxph(Surv(OS, death)~pT, data=lungSCC)
summary(fit_pT)
```
Interpretation:
With a positive coefficient of 1.99 and low p-value of 0.008, we can assume that there is a significant positive relationship between survival time and the pT3 tumor size.


8. pN when nearby lymph nodes are involved
```{r}
fit_pN <- coxph(Surv(OS, death)~pN, data=lungSCC)
summary(fit_pN)
```
Interpretation:
With a positive coefficient of 0.86 and very low p-value of 1.51e-05, we can assume that there is a highly significant positive relationship between survival time and the pN2 tumor size.


9. pM when distant metastasis are involved
```{r}
fit_pM <- coxph(Surv(OS, death)~pM, data=lungSCC)
summary(fit_pM)
```
Interpretation: #CAREFUL WITH THIS ONE
With a positive coefficient of 1.77 and very low p-value of 0.0005, we can assume that there is a highly significant positive relationship between survival time and the pM1b tumor size.


10. smoking state:


11. FEV1_FVC pulmonary function test
```{r}
fit_FEV1FVC <- coxph(Surv(OS, death)~FEV1_FVC, data=lungSCC)
summary(fit_FEV1FVC)
```
Interpretation:
With a p-value of 0.13 we can assume that there is no significant relationship between survival time and the FEV1_FVC pulmonary function test.


12. CEA serum
```{r}
fit_CEA <- coxph(Surv(OS, death)~CEA, data=lungSCC)
summary(fit_CEA)
```
Interpretation:
With a p-value of 0.60 we can assume that there is no significant relationship between survival time and the CEA serum.


13. the type of operation undergone:


14. patient with and without observed metastasis after surgery (meta)
```{r}
fit_meta <- coxph(Surv(OS, death)~meta, data=lungSCC)
summary(fit_meta)
```
Interpretation:
With a very low p-value of 5.22e-08 and a positive coefficient of 0.85, we can assume that there is a highly significant positive relationship between survival time and the observation of metastasis after surgery.


*# Part 3: Kaplan-Meier estimator with features which have a significant relationship with survival time (OS)*
(Only when n of each gr kind of similar)

List of features which have a significant relationship with survival time (OS):
- 
- 
- 


## Comparison between 2 groups of patients based on observed metastasis after surgery

```{r}
fit.KM_meta <- survfit(Surv(OS, death)~meta, data=lungSCC)
fit.KM_meta
```
Interpretation


We plot the Kaplan-Meier survival curve:
```{r}
ggsurvplot(fit.KM_meta,
           legend = "bottom",
           conf.int = TRUE,
           linetype = "strata",
           legend.title = "Observation of metastasis",
           xlab = "Months",
           ylab = "Survival probability")
```



Multivariates Cox Regression 
Start with the full model with all variables
```{r}

lungSCC_fullmodel <- coxph(Surv(OS, death) ~ Location + Obst_pn_or_plugging + Necrosis + Underlying_lung + Effusion + Sex + AG + LN_ratio + cT+ cN + cM + pT+ pN+ pM + Smoking_state + FEV1_FVC + CEA + meta , data = lungSCC)

```


Automatic model selection based on AIC
``` {r}
lungSCC_multiCox <- step(lungSCC_fullmodel)
```
Interpretation:
After backward selection, we found that the best model to predict survival time composes of 11 variables with the converted AIC 1827.39 from the original AIC  
1846.56 

Note that this backward selection migh not convert to global optimum
```{r}
summary(lungSCC_multiCox)
```
Interpretation:
1. The prediction concordance score of our multivariate model is 0.732

2. Features that lead to a statistical significant higher risk (Shorter survival time) are
   - Interstitial lung abnormalitites (ILA) 
     Patients who have underlying lung disease with ILA shows 3 times higher risk than patients who have emphysema 
   - Age
     Patients that older than 60 years old have approximately 2 times higher risk than patients that younger than 60 years old
   - Size of tumor in central lung cancer patients (cT)
     Patients in criteria T2 (Tumor diameter 2.1-4 cm) and T3 (Tumor diameter 4.1-6 cm) have 2 and 3 times higher risk than patients with criteria T1 (Tumor diameter less than or equal to 0 cm), respectively.
    Note that no significant different between patient cT1 and cT4 maybe because we have little number of cT4 patients (n=15)
   - Nearby lymph nodes that are involved in peripheral lung cancer patients (pN)
     Peripheral lung cancer patients whom their cancers spread to lymph nodes within the lung or where the lung joins (N1), lymph nodes in the centre of the chest or under the windpipe brances off to each lung (N2), or lymph nodes on the opposite side of the chest from the affted lung or above the collar bone or at the top of the lung (N3) have approximately 2, 3 and 4 times higher risk than patients who show no nodal involvement.
   - Metastasis of peripheral lung cancer patients (pM)
     Peripheral lung cancer patients whom cancer spread to area outside the chest have 11 times higher risk than patients with no cancer spreading outside the lung
   - Metastasis 
     For both type of lung cancer, patients who have cancer spreading outside the lung have approximately twice higher risk than those without metastasis
   - FEV1/FVC ratio 
     Every increasing unit of FEV1/FVC ratio unit will also increase the risk with approximately 1%

   
3.  Features that lead to a statistical significant lower risk (Longer survival time) are  
   - No underlying lung disease
     Without underlying lung disease, patients have approximately 40% lower risk than patients with emphysema 
   - No smoking history
     Patients who do not smoke have 80% lower risk than patients who have unknown record about smoking

   
Bring all significant feature to make another candidate model
```{r}

lungSCC_multiCox_2 <- coxph(Surv(OS, death) ~ Underlying_lung + AG + cT+ pN+ pM + Smoking_state + FEV1_FVC +  meta , data = lungSCC)

summary(lungSCC_multiCox_2)

```
Interpretation:
The concordance score of this model is less than the previous one which means the first model is better. 

Since lungSCC_multiCox_2 is the nested model of lungSCC_multiCox, to compare both model we will use Likelihood Ratio Test (LRT)


Compaing nested model: LRT
```{r}
anova(lungSCC_multiCox_2, lungSCC_multiCox)
```
Interpretation:
Non significant p-value indicates that there is no significant different in the goodness of fit between these 2 models. 
Even lungSCC_multiCox model is more complex than lungSCC_multiCox_2 but it has higher concordance score, therefore; we will go for this one.
