---
title: "Lung Cancer Prognosis"
author: "Lisa KOPPE, Khwansiri NINPAN, Princy PAPPACHAN"
date: "4/23/2020"
output: pdf_document
---

Paper:
[Integrated evaluation of clinical, pathological and radiological prognostic factors in squamous cell carcinoma of the lung ](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6777828/)

# Import the necessary packages:

```{r}

# REMOVE UNUSED LIBRARIES AT THE END

library(tidyverse)
library(survival)
library(ggplot2)
library(dplyr)
library(tidyr)
```

# Data preparation: load the lung cancer dataset and check data types

```{r}

# CAREFUL: NEED TO REVIEW DATA TYPES (ESPECIALLY LOGICAL)

lungSCC_raw <- read_csv("LungCancer.csv", 
                        col_types=cols(Index='c',
                                       Sex='c',
                                       Age='d',
                                       Location='d',
                                       Obst_pn_or_plugging='d',
                                       CT_value_Mean='d',
                                       CT_value_Std_Dev='d',
                                       CT_value_P_major='d',
                                       CT_V_ratio='d',
                                       CT_Kernel='c',
                                       Necrosis='c',
                                       Underlying_lung='c',
                                       Multiplicity='l',
                                       Effusion='l',
                                       Bronchoscopy='c',
                                       Differentiation='c',
                                       pos_LN='c',
                                       total_LN='d',
                                       LN_ratio='d',
                                       cT='c',
                                       cN='c',
                                       cM='c',
                                       pT='c',
                                       pN='c',
                                       pM='c',
                                       Smoking_state='c',
                                       PY='d',
                                       Cessation_time='d',
                                       FVCpercentPRED='d',
                                       FEV1percentPRED='d',
                                       FEV1_FVC='d',
                                       CEA='d',
                                       post_opCTx='l',
                                       post_op_RTx='l',
                                       op_type='c',
                                       death='c',
                                       recur_or_meta='l',
                                       OP_site_recur='l',
                                       meta='l',
                                       meta_site='c',
                                       OS='d',
                                       DFS='d'))
```

Explore the dataset

```{r}
names(lungSCC_raw)
str(lungSCC_raw)
dim(lungSCC_raw)
head(lungSCC_raw)
summary(lungSCC_raw)
```

Check null value and data classification for all 20 variables.
Use table for classification and Logical column to see how they distribute.
Count null value in decimal column (OS)

```{r}
table(lungSCC_raw$Location, useNA="always")
table(lungSCC_raw$death, useNA="always")
sum(is.na(lungSCC_raw$death))

# Radiologic features
table(lungSCC_raw$Obst_pn_or_plugging, useNA="always")
table(lungSCC_raw$Necrosis, useNA="always")
table(lungSCC_raw$Underlying_lung, useNA="always")
table(lungSCC_raw$Effusion, useNA="always")

# Clinicopathologic features
table(lungSCC_raw$Sex, useNA="always")
table(lungSCC_raw$Age, useNA="always")
table(lungSCC_raw$LN_ratio, useNA="always")
table(lungSCC_raw$cT, useNA="always")
table(lungSCC_raw$cN, useNA="always")
table(lungSCC_raw$cM, useNA="always")
table(lungSCC_raw$pT, useNA="always")
table(lungSCC_raw$pN, useNA="always")
table(lungSCC_raw$pM, useNA="always")
table(lungSCC_raw$Smoking_state, useNA="always")
table(lungSCC_raw$FEV1_FVC, useNA="always")
table(lungSCC_raw$CEA, useNA="always")
table(lungSCC_raw$op_type, useNA="always")
table(lungSCC_raw$meta, useNA="always")
```

Define the meaning of each label to make it easier for interpretation

```{r}

# TO BE COMPLETED

lungSCC <- mutate(lungSCC_raw,
                  Location=ifelse(Location==0, "Invisible",
                                  ifelse(Location==1, "Central", "Peripheral")),
               
                  Necrosis=ifelse(Necrosis==0, "NoRemark",
                                  ifelse(Necrosis==1, "Necrosis", "Cavitization")),
               
                  Underlying_lung=ifelse(Underlying_lung==0, "NoRemark",
                                         ifelse(Underlying_lung==1, "Emphysema", "ILA")))
```

# Features description

1. Location
   = tumor location
   (Class: 0=Invisible, 1=Central SCC, 2=Peripheral SCC)
2. death
   (Logical: 0=Alive, 1=Dead)
3. OS
   = Overall Survival in months: interval between the date of diagnosis and date of death (by any cause)
    
## Radiologic features:

4. Obst_pn_or_plugging
   = presence of obstructive pneumonitis/atelectais
   (Logical: 0=Absent, 1=Present)
5. Necrosis
   (Class: 0=Nothing, 1=Necrosis, 2=Cavitization)
6. Underlying_lung
   = Underlying lung disease
   (Class: 0=No Remarkable, 1=Emphysema, 2=Interstitial lung abnormality)
7. Effusion
   (Logical: 0=Absent, 1=Present)

## Clinicopathologic features: TO BE COMPLETED

8. Sex
   = 
9. Age
   = 
10. LN_ratio
    = lymph node ratio: number of nodes with positive tumor cells divided by the number of all resected nodes
11. cT
    = central / size of original tumor
    (Class: 1=T1, 2=T2, 3=T3, 4=T4)
12. cN
    = central / nearby lymph nodes involved
    (Class: 1=N0, 2=N1, 3=N2, 4=N3)
13. cM
    = central / distant metastasis (spread of cancer from one part of the body to another)
    (Class: 1=M0, 2=M1a, 3=M1b, 4=M1ab, 5=Mx)
14. pT
    = peripheral / size of original tumor
    (Class: 1=T1, 2=T2, 3=T3, 4=T4)
15. pN
    = peripheral / nearby lymph nodes involved
    (Class: 1=N0, 2=N1, 3=N2, 4=N3)
16. pM
    = peripheral / distant metastasis (spread of cancer from one part of the body to another)
    (Class: 1=M0, 2=M1a, 3=M1b, 4=M1ab, 5=Mx)
17. Smoking_state
    = 
18. FEV1_FVC
    = pulmonary function test in %: forced expiratory volume in a second / forced vital capacity
19. CEA
    = serum carcinoembryonic antigen in ng/ml (tumor marker)
20. op_type
    =
21. meta
    = metastasis observed
    (Logical: 0=Absent, 1=Present)


# Part 1: Test relationship between radiologic/clinicopathologic features and death (not considering survival duration)

Methods used:
1. Fisher's exact test (determine the relationship between two categorical variables)
2. Logistic regression (determine the relationship between categorical continuous variables)

## Relationship between radiologic features and death

### Fisher's exact test

Determine the relationship between two categorical variables

Hypotheses:
H0: there is no relationship between the two categorical variables.
H1: the variables are dependent. Knowing the value of one variable helps to predict the value of the other variable.

Odds ratio:
Odds for death in patient with specific condition
divided by odds for death in patient without specific condition
If those 2 sets of patient have equal odds (odds ratio = 1), that specific condition are independent to death status


Here we want to define:
1. Diffence in risk of death in patient with and without obstructive pneumonitis/ atelectais
2. Diffence in risk of death in patient with and without lung effusion


Diffence in risk of death in patient with and without obstructive pneumonitis/ atelectais:
```{r}
with(lungSCC, fisher.test(table(death, Obst_pn_or_plugging)))
```
Interpretation:
p-value is higher than the significance level of 5%, therefore; we cannot reject null hypothesis which means data not sufficinet to prove that obstructive pneumonitis/ atelectais effect the death. 

Odds ratio suggests that patients with obstructive pneumonitis/ atelectais have approximately 17% lower risk of death than that of patient without obstructive pneumonitis/ atelectais
See that 95% confidence interval ranges from 0.55, where patients with pneumonitis/atelectais have 5% lower risk of death than patients without this condition, to 1.25 which means they have 25% higher risk of death than another group of patient.
(Correlate with publication, this feature is suprisingly improve the survival time)


Diffence in risk of death in patient with and without lung effusion:
```{r}
with(lungSCC, fisher.test(table(death, Effusion)))
```
Interpretation:
No relationship between death and lung effusion (p-value = 1)
Patients with lung effusion have 5% higher risk of death than patients without lung effusion

### Logistic regression

----
1. Diffence in risk of death based on cancer location
2. Diffence in risk of death based on cell necrosis
3. Diffence in risk of death based on underlying lung disease
----

1. Diffence in risk of death based on cancer location
```{r}
fit <- glm(death~Location, family="binomial", data=lungSCC)
summary(fit)
```

Interpretation:
1. No significant relationship between location of lung cancer and the prediction of death status.
2. The negative value of estimate coefficient of LocationInvisible indicates that odds of invisible lung cancer is lower than odds of central lung cancer. 
To see the odds ratio between these 2 condition, we have to exponent this coefficients (see belows).
3. Odds of peripheral lung cancer is higher than that of central lung cancer

```{r}
exp(-0.3203)
exp(0.2749)
```
Interpretation:
Risk of death of patients who have invisible lung cancer is around 30% lower than patients with central lung cancer, while risk of death of peripheral lung cancer patients is around 30% higher than that of central lung cancer patients.


2. Diffence in risk of death based on cell necrosis
```{r}
fit <- glm(death~Necrosis, family="binomial", data=lungSCC)
summary(fit)
```

Interpretation:
1. No cell necrosis observation shows significantly negative effect in the prediction of death in lung cancer patients with p-value 0.0238 (i.e No necrosis reduces risk of death).
2. Odds of cell necrosis and invisible cell necrosis are lower than that of cavitization in lung

```{r}
exp(-0.7482)
exp(-0.9840)
```

Interpretation:
Risk of death of lung cancer patients who have necrosis and invisible cell necrosis are around 53% and  63% lower than patients with cavitization.


3. Diffence in risk of death based on underlying lung disease
```{r}
fit <- glm(death~Underlying_lung, family="binomial", data=lungSCC)
summary(fit)
```

Interpretation:
1. Interstitial lung abnormalities (ILA) shows significantly positive relationship with the risk of death with p-value 0.006.
2. Odd of ILA is higher than that of emphysema while odd of negative underlying lung disease is lower than odd of patients with emphysema. 

```{r}
exp(1.81475)
exp(-0.45911)
```

Interpretation:
Risk of death of lung cancer patients with ILA is 6 times higher than patient with emphysema while risk of death of no underlying lung disease patients is 40% lower than patients with emphysema.


## Relationship between clinicopathologic features and death

### Fisher's exact test

Determine the relationship between two categorical variables

Hypotheses:
H0: there is no relationship between the two categorical variables.
H1: the variables are dependent. Knowing the value of one variable helps to predict the value of the other variable.

Odds ratio:
Odds for death in patient with specific condition
divided by odds for death in patient without specific condition
If those 2 sets of patient have equal odds (odds ratio = 1), that specific condition are independent to death status

Here we want to define:
1. Diffence in risk of death in patient with and without obstructive pneumonitis/ atelectais
2. Diffence in risk of death in patient with and without lung effusion


# Part 2:

